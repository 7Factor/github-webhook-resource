#!/usr/bin/env node
'use strict'

const fetch = require('node-fetch');
const stdin = require('get-stdin');
const env = process.env;

stdin().then(str => {
    let input = JSON.parse(str);
    let source = input.source || {};
    let params = input.params || {};

    // validate input

    let githubApi = source.githubApi;
    let githubToken = source.githubToken;
    let org = params.org;
    let repo = params.repo;
    let githubUrl = `${githubApi}/repos/${org}/${repo}/hooks`;

    let resourceName = params.resourceName;
    let webhookToken = params.webhookToken;
    doWork(githubUrl, githubToken, resourceName, webhookToken);
}).catch(error => {
    console.error('Error', error.stack);
    process.exit(1);
});

function doWork(githubUrl, githubToken, resourceName, webhookToken) {
    // /api/v1/teams/TEAM_NAME/pipelines/PIPELINE_NAME/resources/RESOURCE_NAME/check/webhook?webhook_token=WEBHOOK_TOKEN

    let url = `${env.ATC_EXTERNAL_URL}/teams/${env.BUILD_TEAM_NAME}/pipelines/${env.BUILD_PIPELINE_NAME}/resources/${resourceName}/check/webhook?webhook_token=${webhookToken}`;
    
    let config = { 
        'url': url,
        'content-type': 'json'
    };
    
    let body = {
        'name': 'web',
        'config': config
    };
    
    fetch(githubUrl, {
        method: 'POST',
        body: JSON.stringify(body),
        headers:{
          'Content-Type': 'application/json',
          'Authorization': `token ${githubToken}`
        }
      }).then(res => res.json())
      .then(response => { 
          console.log('Success:', JSON.stringify(response));
          process.exit(0);
        })
      .catch(error => {
          console.error('Error:', error.stack);
          process.exit(1);
      });
}